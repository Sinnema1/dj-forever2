name: Deploy

# Deploy only after CI workflow completes successfully on main
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  deploy-server:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Server
        env:
          DEPLOY_URL: ${{ secrets.RENDER_SERVER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$DEPLOY_URL" ]; then
            echo "Error: RENDER_SERVER_DEPLOY_HOOK_URL secret is not set"
            exit 1
          fi
          echo "Triggering server deploy..."
          response=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_URL")
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Server deploy triggered successfully (HTTP $http_code)"
          else
            echo "Server deploy failed (HTTP $http_code)"
            exit 1
          fi

  deploy-client:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Client
        env:
          DEPLOY_URL: ${{ secrets.RENDER_CLIENT_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$DEPLOY_URL" ]; then
            echo "Error: RENDER_CLIENT_DEPLOY_HOOK_URL secret is not set"
            exit 1
          fi
          echo "Triggering client deploy..."
          response=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_URL")
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Client deploy triggered successfully (HTTP $http_code)"
          else
            echo "Client deploy failed (HTTP $http_code)"
            exit 1
          fi
